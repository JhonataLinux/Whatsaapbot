import os
from flask import Flask, request
from twilio.twiml.messaging_response import MessagingResponse
import sqlite3
from datetime import datetime
import re

app = Flask(__name__)

# ConfiguraÃ§Ã£o do banco de dados
DATABASE = 'expenses.db'

def init_db():
    conn = sqlite3.connect(DATABASE)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS expenses
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                 amount REAL,
                 category TEXT,
                 description TEXT,
                 date TEXT)''')
    conn.commit()
    conn.close()

def add_expense(amount, category, description):
    conn = sqlite3.connect(DATABASE)
    c = conn.cursor()
    c.execute("INSERT INTO expenses (amount, category, description, date) VALUES (?, ?, ?, ?)",
              (amount, category, description, datetime.now().strftime('%Y-%m-%d')))
    conn.commit()
    conn.close()

@app.route('/webhook', methods=['POST'])
def webhook():
    incoming_msg = request.values.get('Body', '').lower()
    resp = MessagingResponse()
    
    # LÃ³gica de processamento
    if 'resumo' in incoming_msg:
        # CÃ³digo do resumo...
        resp.message("ðŸ“Š Resumo financeiro")
    else:
        # Processa despesa
        match = re.search(r'(\d+)\s*(reais|r\$)?\s*(?:de|em)?\s*(.*)', incoming_msg)
        if match:
            amount = float(match.group(1))
            category = match.group(3).strip() or 'outros'
            add_expense(amount, category, "")
            resp.message(f"âœ… Registrado: R${amount:.2f} em {category}")
        else:
            resp.message("Formato incorreto. Ex: '100 mercado' ou '50 transporte'")
    
    return str(resp)

if __name__ == '__main__':
    init_db()
    app.run(host='0.0.0.0', port=5000)
